---
title: "Census data transformation"
author: "Stefano De Sabbata"
date: "`r lubridate::now()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This is a **draft**, the analysis is still on-going.

This document focuses on analysing the 2011 Italian census variables to generate a set of transformed variables that can be use for clustering to generate a geodemographic classification. The variables are presented in the table below. The analysis will carry out the following steps:

1. normalisation based on totals or area;
2. transformation of extremely skewed variable;
3. standardisation.

| Variable code | Variable description                                                                                                                                                      | Normalisation                                    |
|---------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
| P1            | Popolazione residente - totale                                                                                                                                            | Area (Km2)                                       |
| P2            | Popolazione residente - maschi                                                                                                                                            | Popolazione residente - totale                   |
| P3            | Popolazione residente - femmine                                                                                                                                           | Popolazione residente - totale                   |
| P4            | Popolazione residente - celibi/nubili                                                                                                                                     | Popolazione residente - totale                   |
| P5            | Popolazione residente - coniugati/e (+ separati/e di fatto)                                                                                                               | Popolazione residente - totale                   |
| P6            | Popolazione residente - separati/e legalmente                                                                                                                             | Popolazione residente - totale                   |
| P7            | Popolazione residente - vedovi/e                                                                                                                                          | Popolazione residente - totale                   |
| P8            | Popolazione residente - divorziati/e                                                                                                                                      | Popolazione residente - totale                   |
| P9            | Popolazione residente - maschi celibi                                                                                                                                     | Popolazione residente - totale                   |
| P10           | Popolazione residente - maschi coniugati o separati di fatto                                                                                                              | Popolazione residente - totale                   |
| P11           | Popolazione residente - maschi separati legalmente                                                                                                                        | Popolazione residente - totale                   |
| P12           | Popolazione residente - maschi vedovi                                                                                                                                     | Popolazione residente - totale                   |
| P13           | Popolazione residente - maschi divorziati                                                                                                                                 | Popolazione residente - totale                   |
| P14           | Popolazione residente - età < 5 anni                                                                                                                                      | Popolazione residente - totale                   |
| P15           | Popolazione residente - età 5 - 9 anni                                                                                                                                    | Popolazione residente - totale                   |
| P16           | Popolazione residente - età 10 - 14 anni                                                                                                                                  | Popolazione residente - totale                   |
| P17           | Popolazione residente - età 15 - 19 anni                                                                                                                                  | Popolazione residente - totale                   |
| P18           | Popolazione residente - età 20 - 24 anni                                                                                                                                  | Popolazione residente - totale                   |
| P19           | Popolazione residente - età 25 - 29 anni                                                                                                                                  | Popolazione residente - totale                   |
| P20           | Popolazione residente - età 30 - 34 anni                                                                                                                                  | Popolazione residente - totale                   |
| P21           | Popolazione residente - età 35 - 39 anni                                                                                                                                  | Popolazione residente - totale                   |
| P22           | Popolazione residente - età 40 - 44 anni                                                                                                                                  | Popolazione residente - totale                   |
| P23           | Popolazione residente - età 45 - 49 anni                                                                                                                                  | Popolazione residente - totale                   |
| P24           | Popolazione residente - età 50 - 54 anni                                                                                                                                  | Popolazione residente - totale                   |
| P25           | Popolazione residente - età 55 - 59 anni                                                                                                                                  | Popolazione residente - totale                   |
| P26           | Popolazione residente - età 60 - 64 anni                                                                                                                                  | Popolazione residente - totale                   |
| P27           | Popolazione residente - età 65 - 69 anni                                                                                                                                  | Popolazione residente - totale                   |
| P28           | Popolazione residente - età 70 - 74 anni                                                                                                                                  | Popolazione residente - totale                   |
| P29           | Popolazione residente - età > 74 anni                                                                                                                                     | Popolazione residente - totale                   |
| P30           | Popolazione residente - maschi - età < 5 anni                                                                                                                             | Popolazione residente - totale                   |
| P31           | Popolazione residente - maschi - età 5 - 9 anni                                                                                                                           | Popolazione residente - totale                   |
| P32           | Popolazione residente - maschi - età 10 - 14 anni                                                                                                                         | Popolazione residente - totale                   |
| P33           | Popolazione residente - maschi - età 15 - 19 anni                                                                                                                         | Popolazione residente - totale                   |
| P34           | Popolazione residente - maschi - età 20 - 24 anni                                                                                                                         | Popolazione residente - totale                   |
| P35           | Popolazione residente - maschi - età 25 - 29 anni                                                                                                                         | Popolazione residente - totale                   |
| P36           | Popolazione residente - maschi - età 30 - 34 anni                                                                                                                         | Popolazione residente - totale                   |
| P37           | Popolazione residente - maschi - età 35 - 39 anni                                                                                                                         | Popolazione residente - totale                   |
| P38           | Popolazione residente - maschi - età 40 - 44 anni                                                                                                                         | Popolazione residente - totale                   |
| P39           | Popolazione residente - maschi - età 45 - 49 anni                                                                                                                         | Popolazione residente - totale                   |
| P40           | Popolazione residente - maschi - età 50 - 54 anni                                                                                                                         | Popolazione residente - totale                   |
| P41           | Popolazione residente - maschi - età 55 - 59 anni                                                                                                                         | Popolazione residente - totale                   |
| P42           | Popolazione residente - maschi - età 60 - 64 anni                                                                                                                         | Popolazione residente - totale                   |
| P43           | Popolazione residente - maschi - età 65 - 69 anni                                                                                                                         | Popolazione residente - totale                   |
| P44           | Popolazione residente - maschi - età 70 - 74 anni                                                                                                                         | Popolazione residente - totale                   |
| P45           | Popolazione residente - maschi - età > 74 anni                                                                                                                            | Popolazione residente - totale                   |
| P46           | Popolazione residente - totale di 6 anni e più                                                                                                                            | Popolazione residente - totale                   |
| P47           | Popolazione residente con laurea vecchio e nuovo ordinamento + diplomi   universitari + diplomi terziari di tipo non universitario vecchio e nuovo   ordinamento          | Popolazione residente - totale                   |
| P48           | Popolazione residente con diploma di scuola secondaria superiore   (maturità + qualifica)                                                                                 | Popolazione residente - totale                   |
| P49           | Popolazione residente con media inferiore                                                                                                                                 | Popolazione residente - totale                   |
| P50           | Popolazione residente con licenza elementare                                                                                                                              | Popolazione residente - totale                   |
| P51           | Popolazione residente - alfabeti                                                                                                                                          | Popolazione residente - totale                   |
| P52           | Popolazione residente - analfabeti                                                                                                                                        | Popolazione residente - totale                   |
| P53           | Popolazione residente - maschi di 6 anni e più                                                                                                                            | Popolazione residente - totale                   |
| P54           | Popolazione residente - maschi con laurea vecchio e nuovo ordinamento +   diplomi universitari + diplomi terziari di tipo non universitario vecchio e   nuovo ordinamento | Popolazione residente - totale                   |
| P55           | Popolazione residente - maschi con diploma di scuola secondaria superiore   (maturità + qualifica)                                                                        | Popolazione residente - totale                   |
| P56           | Popolazione residente - maschi con media inferiore                                                                                                                        | Popolazione residente - totale                   |
| P57           | Popolazione residente - maschi con licenza elementare                                                                                                                     | Popolazione residente - totale                   |
| P58           | Popolazione residente - maschi alfabeti                                                                                                                                   | Popolazione residente - totale                   |
| P59           | Popolazione residente - maschi analfabeti                                                                                                                                 | Popolazione residente - totale                   |
| P60           | Popolazione residente - totale di 15 anni e più appartenente alle forze   di lavoro totale                                                                                | Popolazione residente - totale                   |
| P61           | Popolazione residente - totale di 15 anni e più occupata (FL)                                                                                                             | Popolazione residente - totale                   |
| P62           | Popolazione residente - totale di 15 anni e più disoccupata in cerca   nuova occupazione                                                                                  | Popolazione residente - totale                   |
| P64           | Popolazione residente - maschi di 15 anni e più appartenente alle forze   di lavoro                                                                                       | Popolazione residente - totale                   |
| P65           | Popolazione residente - maschi di 15 anni e più occupata (FL)                                                                                                             | Popolazione residente - totale                   |
| P66           | Popolazione residente - maschi di 15 anni e più disoccupata in cerca   nuova occupazione                                                                                  | Popolazione residente - totale                   |
| P128          | Popolazione residente - totale di 15 anni e più non appartenente alle   forze di lavoro (NFL)                                                                             | Popolazione residente - totale                   |
| P129          | Popolazione residente - maschi di 15 anni e più non appartenente alle   forze di lavoro (NFL)                                                                             | Popolazione residente - totale                   |
| P130          | Popolazione residente - totale di 15 anni e più casalinghi/e                                                                                                              | Popolazione residente - totale                   |
| P131          | Popolazione residente - totale di 15 anni e più studenti                                                                                                                  | Popolazione residente - totale                   |
| P132          | Popolazione residente - totale maschi di 15 anni e più studenti                                                                                                           | Popolazione residente - totale                   |
| P135          | Popolazione residente - totale di 15 anni e più in altra condizione                                                                                                       | Popolazione residente - totale                   |
| P136          | Popolazione residente - totale maschi di 15 anni e più in altra   condizione                                                                                              | Popolazione residente - totale                   |
| P137          | Popolazione residente che si sposta giornalmente nel comune di dimora   abituale                                                                                          | Popolazione residente - totale                   |
| P138          | Popolazione residente che si sposta giornalmente fuori del comune di   dimora abituale                                                                                    | Popolazione residente - totale                   |
| P139          | Popolazione residente - totale di 15 anni e più percettori di reddito da   lavoro o capitale                                                                              | Popolazione residente - totale                   |
| P140          | Popolazione residente - totale maschi di 15 anni e più percettori di   reddito da lavoro o capitale                                                                       | Popolazione residente - totale                   |
| ST1           | Stranieri e apolidi residenti in Italia - totale                                                                                                                          | Popolazione residente - totale                   |
| ST2           | Stranieri e apolidi residenti in Italia - maschi                                                                                                                          | Stranieri e apolidi residenti in Italia - totale |
| ST3           | Stranieri e apolidi residenti in Italia - età 0 - 29 anni                                                                                                                 | Stranieri e apolidi residenti in Italia - totale |
| ST4           | Stranieri e apolidi residenti in Italia - età 30 - 54 anni                                                                                                                | Stranieri e apolidi residenti in Italia - totale |
| ST5           | Stranieri e apolidi residenti in Italia - età > 54 anni                                                                                                                   | Stranieri e apolidi residenti in Italia - totale |
| ST6           | Stranieri e apolidi residenti in Italia - maschi - età 0 - 29 anni                                                                                                        | Stranieri e apolidi residenti in Italia - totale |
| ST7           | Stranieri e apolidi residenti in Italia - maschi - età 30 - 54 anni                                                                                                       | Stranieri e apolidi residenti in Italia - totale |
| ST8           | Stranieri e apolidi residenti in Italia - maschi - età > 54 anni                                                                                                          | Stranieri e apolidi residenti in Italia - totale |
| ST9           | Stranieri residenti in Italia - Europa                                                                                                                                    | Stranieri e apolidi residenti in Italia - totale |
| ST10          | Stranieri residenti in Italia - Africa                                                                                                                                    | Stranieri e apolidi residenti in Italia - totale |
| ST11          | Stranieri residenti in Italia - America                                                                                                                                   | Stranieri e apolidi residenti in Italia - totale |
| ST12          | Stranieri residenti in Italia - Asia                                                                                                                                      | Stranieri e apolidi residenti in Italia - totale |
| ST13          | Stranieri residenti in Italia - Oceania                                                                                                                                   | Stranieri e apolidi residenti in Italia - totale |
| ST14          | Apolidi residenti in Italia                                                                                                                                               | Stranieri e apolidi residenti in Italia - totale |
| ST15          | Stranieri residenti in Italia - totale                                                                                                                                    | Stranieri e apolidi residenti in Italia - totale |
| A2            | Abitazioni occupate da almeno una persona residente                                                                                                                       | Abitazioni (all) ?                               |
| A3            | Abitazioni vuote e abitazioni occupate solo da persone non residenti                                                                                                      | Abitazioni (all) ?                               |
| A5            | Altri tipi di alloggio occupati                                                                                                                                           | Abitazioni (all) ?                               |
| A6            | Abitazioni vuote                                                                                                                                                          | Abitazioni (all) ?                               |
| A7            | Abitazioni occupate solo da persone non residenti                                                                                                                         | Abitazioni (all) ?                               |
| A44           | Superficie delle abitazioni occupate da almeno una persona residente                                                                                                      | Area (Km2) ?                                     |
| A46           | Famiglie in alloggi in affitto                                                                                                                                            | Famiglie residenti - totale                      |
| A47           | Famiglie in alloggi di proprietà                                                                                                                                          | Famiglie residenti - totale                      |
| A48           | Famiglie che occupano l'alloggio ad altro titolo                                                                                                                          | Famiglie residenti - totale                      |
| PF1           | Famiglie residenti - totale                                                                                                                                               | Famiglie residenti - totale                      |
| PF2           | Famiglie residenti - totale componenti                                                                                                                                    | Famiglie residenti - totale                      |
| PF3           | Famiglie residenti - 1 componente                                                                                                                                         | Famiglie residenti - totale                      |
| PF4           | Famiglie residenti - 2 componenti                                                                                                                                         | Famiglie residenti - totale                      |
| PF5           | Famiglie residenti - 3 componenti                                                                                                                                         | Famiglie residenti - totale                      |
| PF6           | Famiglie residenti - 4 componenti                                                                                                                                         | Famiglie residenti - totale                      |
| PF7           | Famiglie residenti - 5 componenti                                                                                                                                         | Famiglie residenti - totale                      |
| PF8           | Famiglie residenti - 6 e oltre componenti                                                                                                                                 | Famiglie residenti - totale                      |
| PF9           | Componenti delle famiglie residenti di 6 e oltre componenti                                                                                                               | Popolazione residente - totale                   |
| E1            | Edifici e complessi di edifici - totale                                                                                                                                   | Area (Km2)                                       |
| E2            | Edifici e complessi di edifici utilizzati                                                                                                                                 | Edifici e complessi di edifici - totale          |
| E3            | Edifici ad uso residenziale                                                                                                                                               | Edifici e complessi di edifici - totale          |
| E4            | Edifici e complessi di edifici (utilizzati) ad uso produttivo,   commerciale, direzionale/terziario, turistico/ricettivo, servizi, altro                                  | Edifici e complessi di edifici - totale          |
| E5            | Edifici ad uso residenziale in muratura portante                                                                                                                          | Edifici e complessi di edifici - totale          |
| E6            | Edifici ad uso residenziale in calcestruzzo armato                                                                                                                        | Edifici e complessi di edifici - totale          |
| E7            | Edifici ad uso residenziale in altro materiale (acciaio, legno, ecc.)                                                                                                     | Edifici e complessi di edifici - totale          |
| E8            | Edifici ad uso residenziale costruiti prima del 1919                                                                                                                      | Edifici e complessi di edifici - totale          |
| E9            | Edifici ad uso residenziale costruiti dal 1919 al 1945                                                                                                                    | Edifici e complessi di edifici - totale          |
| E10           | Edifici ad uso residenziale costruiti dal 1946 al 1960                                                                                                                    | Edifici e complessi di edifici - totale          |
| E11           | Edifici ad uso residenziale costruiti dal 1961 al 1970                                                                                                                    | Edifici e complessi di edifici - totale          |
| E12           | Edifici ad uso residenziale costruiti dal 1971 al 1980                                                                                                                    | Edifici e complessi di edifici - totale          |
| E13           | Edifici ad uso residenziale costruiti dal 1981 al 1990                                                                                                                    | Edifici e complessi di edifici - totale          |
| E14           | Edifici ad uso residenziale costruiti dal 1991 al 2000                                                                                                                    | Edifici e complessi di edifici - totale          |
| E15           | Edifici ad uso residenziale costruiti dal 2001 al 2005                                                                                                                    | Edifici e complessi di edifici - totale          |
| E16           | Edifici ad uso residenziale costruiti dopo il 2005                                                                                                                        | Edifici e complessi di edifici - totale          |
| E17           | Edifici ad uso residenziale con un piano                                                                                                                                  | Edifici e complessi di edifici - totale          |
| E18           | Edifici ad uso residenziale con 2 piani                                                                                                                                   | Edifici e complessi di edifici - totale          |
| E19           | Edifici ad uso residenziale con 3 piani                                                                                                                                   | Edifici e complessi di edifici - totale          |
| E20           | Edifici ad uso residenziale con 4 piani o più                                                                                                                             | Edifici e complessi di edifici - totale          |
| E21           | Edifici ad uso residenziale con un interno                                                                                                                                | Edifici e complessi di edifici - totale          |
| E22           | Edifici ad uso residenziale con 2 interni                                                                                                                                 | Edifici e complessi di edifici - totale          |
| E23           | Edifici ad uso residenziale da 3 a 4 interni                                                                                                                              | Edifici e complessi di edifici - totale          |
| E24           | Edifici ad uso residenziale da 5 a 8 interni                                                                                                                              | Edifici e complessi di edifici - totale          |
| E25           | Edifici ad uso residenziale da 9 a 15 interni                                                                                                                             | Edifici e complessi di edifici - totale          |
| E26           | Edifici ad uso residenziale con 16 interni o più                                                                                                                          | Edifici e complessi di edifici - totale          |
| E27           | Totale interni in edifici ad uso residenziale                                                                                                                             | Edifici e complessi di edifici - totale          |
| E28           | Edifici ad uso residenziale con stato di conservazione ottimo                                                                                                             | Edifici e complessi di edifici - totale          |
| E29           | Edifici ad uso residenziale con stato di conservazione buono                                                                                                              | Edifici e complessi di edifici - totale          |
| E30           | Edifici ad uso residenziale con stato di conservazione mediocre                                                                                                           | Edifici e complessi di edifici - totale          |
| E31           | Edifici ad uso residenziale con stato di conservazione pessimo                                                                                                            | Edifici e complessi di edifici - totale          |

## Setup

```{r libraries, warning=FALSE, message=FALSE}
library(tidyverse)
library(magrittr)
library(pastecs)
library(moments)
```



## Data

```{r data}
census_data <- 
  read_csv(
    "../storage/dati-cpa_2011_all.csv",
    col_types = paste(c(rep("c", 12), rep("i", 140)), collapse="")
  ) %>% 
  left_join(
    read_csv(
      "../storage/italian-enumeration-areas-2011-size-km2.csv",
      col_types = "cd"
    )
  )
```



## Missing values

Check missing values.

```{r}
census_data %>% 
  select(P1:E31) %>% 
  stat.desc() %>% 
  rownames_to_column() %>% 
  filter(rowname %in% c("nbr.na")) %>% 
  pivot_longer(-rowname, names_to = "variable", values_to = "values") %>% 
  pivot_wider(names_from = "rowname", values_from = "values")
```

```{r}
census_data_na <-
  census_data %>% 
  filter(if_any(P1:E31, ~is.na(.)))

census_data_na %>% 
  group_by(REGIONE, PROVINCIA) %>% 
  count(sort = TRUE) %>% 
  ungroup() %>% 
  slice_max(order_by = n, n = 10)
```

There seem to be 2,400 enumeration areas without information for `E5`, `E6` and `E7`. Those will be removed.

```{r}
census_data_no_na <-
  census_data %>% 
  filter(if_any(P1:E31, ~!is.na(.)))
```



## Normalisation

Normalise data based on their totals. Assign zero where the total for that area is zero.

```{r normalisation}
census_data_norm <-
  census_data_no_na %>% 
  #
  #----------------------------------------------
  # Popolazione residente
  mutate(across(
    P2:P140, 
    function(x){if_else(P1 == 0, 0, x / P1)}
  )) %>% 
  dplyr::rename_with(
    function(x){ paste0(x, "_norm") },
    P2:P140
  ) %>% 
  #
  #----------------------------------------------
  # Stranieri
  # ST13 and ST14 removed as almost always zero
  # ST15 removed as almost always one or zero
  select(-ST13, -ST14, -ST15) %>% 
  mutate(across(
    ST2:ST12, 
    function(x){if_else(ST1 == 0, 0, x / ST1)}
  )) %>%
  dplyr::rename_with(
    function(x){ paste0(x, "_norm") },
    ST2:ST12
  ) %>% 
  #
  #----------------------------------------------
  # Abitazioni
  # Sum all A2 to A7 values for normalisation then remove
  # A7 also removed as almost always zero
  mutate(A1_guess = A2 + A3 + A5 + A6 + A7) %>% 
  mutate(across(
    A2:A6, 
    function(x){if_else(A1_guess == 0, 0, x / A1_guess)}
  )) %>% 
  dplyr::rename_with(
    function(x){ paste0(x, "_norm") },
    A2:A6
  ) %>% 
  select(-A1_guess, -A7) %>% 
  #
  #----------------------------------------------
  # Famiglie in alloggi
  mutate(across(
    A46:A48, 
    function(x){if_else(PF1 == 0, 0, x / PF1)}
  )) %>% 
  dplyr::rename_with(
    function(x){ paste0(x, "_norm") },
    A46:A48
  ) %>% 
  #
  #----------------------------------------------
  # Famiglie
  mutate(across(
    PF2:PF8, 
    function(x){if_else(PF1 == 0, 0, x / PF1)}
  )) %>% 
  mutate(
    PF9 = if_else(PF1 == 0, 0, PF9 / P1)
  ) %>% 
  dplyr::rename_with(
    function(x){ paste0(x, "_norm") },
    PF2:PF9
  ) %>% 
  #
  #----------------------------------------------
  # Edifici
  # E2 not normalised as the vast majority of buildings are used
  # and normalisation results in a very long left tail, not used
  select(-E2) %>% 
  mutate(across(
    E3:E31, 
    function(x){if_else(E1 == 0, 0, x / E1)}
  )) %>% 
  dplyr::rename_with(
    function(x){ paste0(x, "_norm") },
    E3:E31
  ) %>% 
  #
  #----------------------------------------------
  # Area-based normalisations
  mutate(across(
    all_of(c("P1", "A44", "E1")), 
    function(x){x / sez_area_km2}
  )) %>% 
  dplyr::rename_with(
    function(x){ paste0(x, "_norm") },
    all_of(c("P1", "A44", "E1"))
  ) %>% 
  select(-sez_area_km2)
```

Double-check missing values and `NaN`.

```{r}
census_data_norm %>% 
  filter(if_any(P1_norm:E31_norm, ~is.na(.))) %>% 
  count() %>% 
  pull(n)

census_data_norm %>% 
  filter(if_any(P1_norm:E31_norm, ~is.nan(.))) %>% 
  count() %>% 
  pull(n)
```

No missing values nor `NaN`.



## Skewness

```{r}
census_data_norm_skewness <-
  census_data_norm %>% 
  select(P1_norm:E31_norm) %>% 
  summarise(across(P1_norm:E31_norm, skewness)) %>% 
  pivot_longer(P1_norm:E31_norm, names_to = "variable", values_to = "skewness")

census_data_norm_skewness %>% 
  slice_max(order_by = skewness, n = 10)

census_data_norm_skewness %>% 
  slice_min(order_by = skewness, n = 10)
```

```{r}
census_data_norm %>%
  select(
    E1_norm, P1_norm, A44_norm, 
    ST1, P59_norm, A5_norm, 
    P13_norm, P11_norm, P46_norm
  ) %>% 
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~variable, scales = "free")
```

Apply a `log10` transformation to all variables with skewness above 2 or below -2.

```{r}
skewed_vars <-
  census_data_norm_skewness %>% 
  filter(skewness > 2 | skewness < -2) %>% 
  pull(variable)

census_data_norm_unskewed <-
  census_data_norm %>% 
  mutate(
    across(
      all_of(skewed_vars),
      # use +1 to shift the log10 curve
      function(x)(log10(x+1))
    )
  ) %>% 
  dplyr::rename_with(
    function(x){ paste0(x, "_log10") },
    all_of(skewed_vars)
  )
```

```{r}
census_data_norm_unskewed %>% 
  select(P1_norm_log10:E31_norm_log10) %>% 
  summarise(across(P1_norm_log10:E31_norm_log10, skewness)) %>% 
  pivot_longer(P1_norm_log10:E31_norm_log10, names_to = "variable", values_to = "skewness") %>% 
  slice_max(order_by = skewness, n = 10)

census_data_norm_unskewed %>% 
  select(P1_norm_log10:E31_norm_log10) %>% 
  summarise(across(P1_norm_log10:E31_norm_log10, skewness)) %>% 
  pivot_longer(P1_norm_log10:E31_norm_log10, names_to = "variable", values_to = "skewness") %>% 
  slice_min(order_by = skewness, n = 10)
```

```{r}
census_data_norm_unskewed %>%
  select(
    E1_norm_log10, P1_norm_log10, A44_norm_log10, 
    ST1_log10, P59_norm_log10, A5_norm_log10, 
    P13_norm_log10, P11_norm_log10, P46_norm_log10
  ) %>% 
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~variable, scales = "free")
```



## Standardisation

```{r}
census_data_norm_unskewed_std <-
  census_data_norm_unskewed %>% 
  mutate(
    across(
      P1_norm_log10:E31_norm_log10,
      function(x){ scale(x) %>% as.vector() }
    )
  ) %>% 
  dplyr::rename_with(
    function(x){ paste0(x, "_std") },
    P1_norm_log10:E31_norm_log10
  )
```



## Save new values

```{r}
colnames(census_data_norm_unskewed_std)
```

```{r}
census_data_norm_unskewed_std %>% 
  write_csv("../storage/dati-cpa_2011_all-trans-v0_0_1.csv")
```



## Conclusions

This is a **draft**, the analysis is still on-going.

There is still a lot of very skewed variables. Those will probably need to be combined or dropped. 



## Acknowledgements

This analysis uses data from [ISTAT](https://www.istat.it/it/archivio/104317) distributed under [CC BY 3.0 IT](https://creativecommons.org/licenses/by/3.0/it/deed.en) (see also [legal notice](https://www.istat.it/it/note-legali)).
